<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Education Data Dashboard</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            overflow: hidden;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 400px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }

        .header {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 300;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .status {
            background: rgba(0, 255, 136, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(0, 255, 136, 0.3);
            font-size: 14px;
        }

        .map-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel h3 {
            margin-bottom: 15px;
            color: #4fc3f7;
            font-weight: 400;
            text-align: center;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-danger {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #4fc3f7;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .data-table {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
        }

        .data-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .chart-container {
            height: 250px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100px;
            flex-direction: column;
            gap: 10px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #4fc3f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 107, 107, 0.3);
            margin-bottom: 15px;
        }

        /* Custom Leaflet styling */
        .leaflet-control-container .leaflet-control {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 8px;
        }

        .leaflet-popup-content-wrapper {
            background: rgba(30, 60, 114, 0.95);
            color: white;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .leaflet-popup-content {
            margin: 15px;
        }

        .selected-area {
            fill: rgba(255, 193, 7, 0.3) !important;
            stroke: rgba(255, 193, 7, 0.8) !important;
            stroke-width: 3 !important;
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr 400px;
            }
            
            .sidebar {
                overflow-y: visible;
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>ðŸ“š Education Data Dashboard</h1>
            <div class="status" id="status">Ready</div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
        </div>
        
        <div class="sidebar">
            <div class="panel">
                <h3>ðŸŽ¯ Selection Tools</h3>
                <div class="controls">
                    <button class="btn" onclick="startPolygonSelection()">Draw Selection Area</button>
                    <button class="btn btn-danger" onclick="clearSelection()" disabled id="clearBtn">Clear Selection</button>
                    <button class="btn btn-success" onclick="downloadCSV()" disabled id="downloadBtn">ðŸ“¥ Download CSV</button>
                </div>
            </div>
            
            <div class="panel" id="summaryPanel" style="display: none;">
                <h3>ðŸ“Š Selection Summary</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="selectedZips">0</div>
                        <div class="stat-label">ZIP Codes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalStudents">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalSchools">0</div>
                        <div class="stat-label">Schools</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgPoverty">0%</div>
                        <div class="stat-label">Avg Poverty</div>
                    </div>
                </div>
            </div>
            
            <div class="panel" id="tablePanel" style="display: none;">
                <h3>ðŸ“‹ Aggregate Data</h3>
                <div class="data-table">
                    <table id="aggregateTable">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div class="panel" id="chartPanel" style="display: none;">
                <h3>ðŸ“ˆ Demographics Chart</h3>
                <div class="chart-container">
                    <canvas id="demographicsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.min.js"></script>

    <script>
        // Check if libraries loaded correctly
        if (typeof L === 'undefined') {
            console.error('Leaflet failed to load');
            document.getElementById('status').textContent = 'âŒ Leaflet library failed to load';
            document.getElementById('status').style.background = 'rgba(255, 107, 107, 0.2)';
        }

        let map;
        let geoJsonLayer;
        let drawnItems;
        let drawControl;
        let currentChart;
        let geoJsonData;
        let selectedFeatures = [];
        let aggregatedData = {};

        // Wait for all libraries to load
        function checkLibraries() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5 seconds max wait
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    if (typeof L !== 'undefined' && 
                        typeof L.Control !== 'undefined' && 
                        typeof L.Control.Draw !== 'undefined' &&
                        typeof Chart !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Libraries failed to load within timeout'));
                    }
                }, 100);
            });
        }

        // Initialize the map
        async function initMap() {
            try {
                await checkLibraries();
                
                map = L.map('map').setView([39.8283, -98.5795], 4);
                
                // Add dark tile layer for better visual appeal
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(map);

                // Initialize draw control
                drawnItems = new L.FeatureGroup();
                map.addLayer(drawnItems);

                drawControl = new L.Control.Draw({
                    edit: {
                        featureGroup: drawnItems
                    },
                    draw: {
                        polygon: true,
                        polyline: false,
                        rectangle: true,
                        circle: false,
                        circlemarker: false,
                        marker: false
                    }
                });

                map.addControl(drawControl);

                // Handle drawing events
                map.on(L.Draw.Event.CREATED, handleDrawCreate);
                map.on(L.Draw.Event.DELETED, handleDrawDelete);
                
                updateStatus('Map initialized successfully');
                
            } catch (error) {
                console.error('Failed to initialize map:', error);
                updateStatus('Failed to initialize map. Please refresh the page.', false, true);
            }
        }

        // Load GeoJSON data
        async function loadGeoJson() {
            try {
                updateStatus('Loading education data...', true);
                
                // Try to load the GeoJSON file
                let response;
                let geoJsonFileName = 'education-data.geojson';
                
                try {
                    response = await fetch(geoJsonFileName);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                } catch (fetchError) {
                    // If the main file fails, try some common alternatives
                    const alternatives = ['data.geojson', 'education.geojson', 'school-data.geojson'];
                    let loaded = false;
                    
                    for (const alt of alternatives) {
                        try {
                            response = await fetch(alt);
                            if (response.ok) {
                                geoJsonFileName = alt;
                                loaded = true;
                                break;
                            }
                        } catch (e) {
                            // Continue to next alternative
                        }
                    }
                    
                    if (!loaded) {
                        throw new Error(`Could not find GeoJSON file. Please ensure your file is named 'education-data.geojson' and is in the same directory as this HTML file.`);
                    }
                }
                
                geoJsonData = await response.json();
                
                if (!geoJsonData.features || geoJsonData.features.length === 0) {
                    throw new Error('GeoJSON file appears to be empty or invalid');
                }
                
                // Validate required properties
                const firstFeature = geoJsonData.features[0];
                const requiredProps = ['Zip', 'Total_Student'];
                const missingProps = requiredProps.filter(prop => !(prop in firstFeature.properties));
                
                if (missingProps.length > 0) {
                    console.warn('Missing expected properties:', missingProps);
                }
                
                // Add GeoJSON layer to map
                geoJsonLayer = L.geoJSON(geoJsonData, {
                    style: {
                        color: '#4fc3f7',
                        weight: 1,
                        opacity: 0.8,
                        fillColor: '#4fc3f7',
                        fillOpacity: 0.2
                    },
                    onEachFeature: function(feature, layer) {
                        // Add popup with basic info
                        const props = feature.properties;
                        const popupContent = `
                            <strong>ZIP: ${props.Zip || 'N/A'}</strong><br>
                            Students: ${props.Total_Student ? props.Total_Student.toLocaleString() : 'N/A'}<br>
                            Schools: ${props.School_Count || 'N/A'}<br>
                            Poverty Rate: ${props.poverty_pct ? props.poverty_pct.toFixed(1) + '%' : 'N/A'}
                        `;
                        layer.bindPopup(popupContent);
                    }
                }).addTo(map);
                
                // Fit map to data bounds
                if (geoJsonData.features.length > 0) {
                    map.fitBounds(geoJsonLayer.getBounds());
                }
                
                updateStatus(`Data loaded: ${geoJsonData.features.length} ZIP codes`);
                
            } catch (error) {
                console.error('Error loading GeoJSON:', error);
                updateStatus(error.message, false, true);
                
                // Show instructions for fixing the issue
                setTimeout(() => {
                    alert(`Data Loading Error:

${error.message}

To fix this:
1. Make sure your GeoJSON file is named 'education-data.geojson'
2. Place it in the same directory as this HTML file
3. Ensure the file contains valid GeoJSON with your education data
4. Refresh the page

The file should have properties like: Zip, Total_Student, School_Count, poverty_pct, etc.`);
                }, 1000);
            }
        }

        // Handle polygon drawing
        function handleDrawCreate(e) {
            const layer = e.layer;
            drawnItems.addLayer(layer);
            
            // Find intersecting features
            findIntersectingFeatures(layer);
            
            // Enable clear and download buttons
            document.getElementById('clearBtn').disabled = false;
            document.getElementById('downloadBtn').disabled = false;
        }

        // Handle polygon deletion
        function handleDrawDelete(e) {
            selectedFeatures = [];
            aggregatedData = {};
            hideDataPanels();
            
            // Disable buttons if no drawn items
            if (drawnItems.getLayers().length === 0) {
                document.getElementById('clearBtn').disabled = true;
                document.getElementById('downloadBtn').disabled = true;
            }
        }

        // Find features that intersect with drawn polygon
        function findIntersectingFeatures(drawnLayer) {
            selectedFeatures = [];
            
            geoJsonLayer.eachLayer(function(layer) {
                if (isFeatureInPolygon(layer, drawnLayer)) {
                    selectedFeatures.push(layer.feature);
                    // Highlight selected feature
                    layer.setStyle({
                        color: '#ffc107',
                        weight: 3,
                        fillColor: '#ffc107',
                        fillOpacity: 0.4
                    });
                } else {
                    // Reset style for unselected features
                    layer.setStyle({
                        color: '#4fc3f7',
                        weight: 1,
                        fillColor: '#4fc3f7',
                        fillOpacity: 0.2
                    });
                }
            });
            
            if (selectedFeatures.length > 0) {
                aggregateData();
                showDataPanels();
            }
        }

        // Check if feature intersects with polygon (simplified)
        function isFeatureInPolygon(feature, polygon) {
            const featureBounds = feature.getBounds();
            const polygonBounds = polygon.getBounds();
            
            // Simple bounding box intersection check
            return featureBounds.intersects(polygonBounds);
        }

        // Aggregate selected data
        function aggregateData() {
            if (selectedFeatures.length === 0) return;
            
            // Count fields to sum
            const countFields = [
                'Total_Student', 'Female', 'Male', 'Pre_K', 'KG', 'Grade_1', 'Grade_2', 
                'Grade_3', 'Grade_4', 'Grade_5', 'Grade_6', 'Grade_7', 'Grade_8', 
                'Grade_9', 'Grade_10', 'Grade_11', 'Grade_12', 'Asian', 'Black', 
                'Hispanic', 'White', 'School_Count', 'pop'
            ];
            
            // Percentage fields to average
            const percentFields = ['Student_Ratio', 'poverty_pct', 'unemployment_pct', 'bachAtleast_pct'];
            
            // Other fields to average
            const avgFields = ['med_income'];
            
            aggregatedData = {};
            
            // Initialize sums
            countFields.forEach(field => aggregatedData[field] = 0);
            percentFields.forEach(field => aggregatedData[field] = 0);
            avgFields.forEach(field => aggregatedData[field] = 0);
            
            // Sum count fields
            selectedFeatures.forEach(feature => {
                const props = feature.properties;
                countFields.forEach(field => {
                    if (props[field] && !isNaN(props[field])) {
                        aggregatedData[field] += props[field];
                    }
                });
            });
            
            // Calculate averages for percentage and other fields
            const validFeatures = selectedFeatures.length;
            
            percentFields.concat(avgFields).forEach(field => {
                let sum = 0;
                let count = 0;
                selectedFeatures.forEach(feature => {
                    const props = feature.properties;
                    if (props[field] && !isNaN(props[field])) {
                        sum += props[field];
                        count++;
                    }
                });
                aggregatedData[field] = count > 0 ? sum / count : 0;
            });
            
            aggregatedData.zip_count = selectedFeatures.length;
            
            updateSummaryCards();
            updateAggregateTable();
            updateChart();
        }

        // Update summary cards
        function updateSummaryCards() {
            document.getElementById('selectedZips').textContent = aggregatedData.zip_count;
            document.getElementById('totalStudents').textContent = aggregatedData.Total_Student?.toLocaleString() || '0';
            document.getElementById('totalSchools').textContent = aggregatedData.School_Count || '0';
            document.getElementById('avgPoverty').textContent = aggregatedData.poverty_pct ? aggregatedData.poverty_pct.toFixed(1) + '%' : '0%';
        }

        // Update aggregate data table
        function updateAggregateTable() {
            const tbody = document.querySelector('#aggregateTable tbody');
            tbody.innerHTML = '';
            
            const displayData = [
                { label: 'ZIP Codes', value: aggregatedData.zip_count },
                { label: 'Total Students', value: aggregatedData.Total_Student?.toLocaleString() },
                { label: 'Total Schools', value: aggregatedData.School_Count },
                { label: 'Total Population', value: aggregatedData.pop?.toLocaleString() },
                { label: 'Avg Median Income', value: aggregatedData.med_income ? '$' + aggregatedData.med_income.toLocaleString() : 'N/A' },
                { label: 'Avg Poverty Rate', value: aggregatedData.poverty_pct ? aggregatedData.poverty_pct.toFixed(1) + '%' : 'N/A' },
                { label: 'Avg Unemployment', value: aggregatedData.unemployment_pct ? aggregatedData.unemployment_pct.toFixed(1) + '%' : 'N/A' },
                { label: 'Avg Bachelor+', value: aggregatedData.bachAtleast_pct ? aggregatedData.bachAtleast_pct.toFixed(1) + '%' : 'N/A' }
            ];
            
            displayData.forEach(item => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = item.label;
                row.insertCell(1).textContent = item.value;
            });
        }

        // Update demographics chart
        function updateChart() {
            const ctx = document.getElementById('demographicsChart').getContext('2d');
            
            if (currentChart) {
                currentChart.destroy();
            }
            
            const data = {
                labels: ['Asian', 'Black', 'Hispanic', 'White'],
                datasets: [{
                    label: 'Student Demographics',
                    data: [
                        aggregatedData.Asian || 0,
                        aggregatedData.Black || 0,
                        aggregatedData.Hispanic || 0,
                        aggregatedData.White || 0
                    ],
                    backgroundColor: [
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(220, 53, 69, 0.8)',
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(0, 123, 255, 0.8)'
                    ],
                    borderColor: [
                        'rgba(255, 193, 7, 1)',
                        'rgba(220, 53, 69, 1)',
                        'rgba(40, 167, 69, 1)',
                        'rgba(0, 123, 255, 1)'
                    ],
                    borderWidth: 2
                }]
            };
            
            currentChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.8)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.8)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Show data panels
        function showDataPanels() {
            document.getElementById('summaryPanel').style.display = 'block';
            document.getElementById('tablePanel').style.display = 'block';
            document.getElementById('chartPanel').style.display = 'block';
        }

        // Hide data panels
        function hideDataPanels() {
            document.getElementById('summaryPanel').style.display = 'none';
            document.getElementById('tablePanel').style.display = 'none';
            document.getElementById('chartPanel').style.display = 'none';
        }

        // Start polygon selection
        function startPolygonSelection() {
            // Programmatically trigger polygon draw
            new L.Draw.Polygon(map, drawControl.options.polygon).enable();
        }

        // Clear all selections
        function clearSelection() {
            drawnItems.clearLayers();
            selectedFeatures = [];
            aggregatedData = {};
            
            // Reset all feature styles
            if (geoJsonLayer) {
                geoJsonLayer.eachLayer(function(layer) {
                    layer.setStyle({
                        color: '#4fc3f7',
                        weight: 1,
                        fillColor: '#4fc3f7',
                        fillOpacity: 0.2
                    });
                });
            }
            
            hideDataPanels();
            document.getElementById('clearBtn').disabled = true;
            document.getElementById('downloadBtn').disabled = true;
        }

        // Download CSV
        function downloadCSV() {
            if (Object.keys(aggregatedData).length === 0) return;
            
            // Prepare CSV data
            let csvContent = "Metric,Value\n";
            
            Object.entries(aggregatedData).forEach(([key, value]) => {
                let displayValue = value;
                if (typeof value === 'number') {
                    if (key.includes('pct') || key.includes('Ratio')) {
                        displayValue = value.toFixed(2) + '%';
                    } else if (key === 'med_income') {
                        displayValue = '$' + value.toLocaleString();
                    } else {
                        displayValue = value.toLocaleString();
                    }
                }
                csvContent += `"${key.replace(/_/g, ' ')}","${displayValue}"\n`;
            });
            
            // Add selected ZIP codes
            csvContent += "\nSelected ZIP Codes\n";
            selectedFeatures.forEach(feature => {
                csvContent += `"${feature.properties.Zip}"\n`;
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `education_data_aggregate_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            updateStatus('CSV downloaded successfully');
        }

        // Update status
        function updateStatus(message, isLoading = false, isError = false) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status';
            
            if (isLoading) {
                statusEl.textContent = 'â³ ' + message;
            } else if (isError) {
                statusEl.textContent = 'âŒ ' + message;
                statusEl.style.background = 'rgba(255, 107, 107, 0.2)';
                statusEl.style.borderColor = 'rgba(255, 107, 107, 0.3)';
            } else {
                statusEl.textContent = 'âœ… ' + message;
                setTimeout(() => {
                    statusEl.textContent = 'Ready';
                    statusEl.style.background = 'rgba(0, 255, 136, 0.2)';
                    statusEl.style.borderColor = 'rgba(0, 255, 136, 0.3)';
                }, 3000);
            }
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            updateStatus('Initializing dashboard...', true);
            try {
                await initMap();
                await loadGeoJson();
            } catch (error) {
                console.error('Initialization failed:', error);
                updateStatus('Failed to initialize dashboard', false, true);
            }
        });
    </script>
</body>
</html>